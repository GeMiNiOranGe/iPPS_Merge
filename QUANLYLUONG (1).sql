CREATE DATABASE QUANLYLUONG
GO

USE QUANLYLUONG
GO

-- TẠO BẢNG TÀI KHOẢN
CREATE TABLE TAIKHOAN
(
	USERNAME VARCHAR(10) PRIMARY KEY,
	PASSWORD NVARCHAR(30) NOT NULL,
	LOAITK TINYINT NOT NULL,
)
INSERT TAIKHOAN VALUES ('123', '123', 1) -- KHỎI THÊM

-- TẠO BẢNG PHÒNG BAN
CREATE TABLE PHONGBAN
(
    MAPB VARCHAR(10) PRIMARY KEY,
    TENPB NVARCHAR(50),
    DIACHI NVARCHAR(100),
)
INSERT PHONGBAN VALUES ('PB001', N'Phòng ban ABC', N'TP Hồ Chí Minh')
INSERT PHONGBAN VALUES ('PB002', N'Phòng ban EFG', N'Bình Dương')
INSERT PHONGBAN VALUES ('PB003', N'Phòng ban HKJ', N'Đồng Nai') -- KHỎI THÊM

-- TẠO BẢNG CHỨC VỤ
CREATE TABLE CHUCVU
(
    MACV VARCHAR(10) PRIMARY KEY,
    TENCV NVARCHAR(50),
    HESOPHUCAP DECIMAL(10,1), -- HỆ SỐ PHỤ CẤP
    MAPB VARCHAR(10),

    FOREIGN KEY(MAPB) REFERENCES PHONGBAN(MAPB),
)
INSERT CHUCVU VALUES ('CV001', N'Quản lý', 3, 'PB001')
INSERT CHUCVU VALUES ('CV002', N'Kế toán', 2, 'PB002')-- ghi thêm chức vụ, mỗi phòng ban đều có chức vụ, chức vụ giữa các phòng ban có thể trùng nhau
INSERT CHUCVU VALUES ('CV003', N'Kiểm toán', 2, 'PB003')
INSERT CHUCVU VALUES ('CV004', N'Trưởng phòng', 2.2, 'PB002')
INSERT CHUCVU VALUES ('CV005', N'Nhân viên Content Marketing', 3, 'PB001')

-- TẠO BẢNG NGẠCH LƯƠNG
CREATE TABLE NGACHLUONG
(
    MANL VARCHAR(10) PRIMARY KEY,
	TENNL NVARCHAR(20),
    MOTA NVARCHAR(100),
)
INSERT NGACHLUONG VALUES ('NL001', N'Ngạch lương I', null)
INSERT NGACHLUONG VALUES ('NL002', N'Ngạch lương II', null)
INSERT NGACHLUONG VALUES ('NL003', N'Ngạch lương III', null)
INSERT NGACHLUONG VALUES ('NL004', N'Ngạch lương IV', null)
INSERT NGACHLUONG VALUES ('NL005', N'Ngạch lương V', null)

-- TẠO BẢNG BẬC LƯƠNG
CREATE TABLE BACLUONG
(
    MABL VARCHAR(10) PRIMARY KEY,
	TENBL NVARCHAR(20),
    HESOBL DECIMAL(10,1),
    MOTA NVARCHAR(100),
    MANL VARCHAR(10),

    FOREIGN KEY(MANL) REFERENCES NGACHLUONG(MANL),
)
INSERT BACLUONG VALUES ('BL001', N'Bậc lương I', 6.20, null, 'NL001')
INSERT BACLUONG VALUES ('BL002', N'Bậc lương II', 6.56, null, 'NL002')
INSERT BACLUONG VALUES ('BL003', N'Bậc lương III', 6.92, null, 'NL003')
INSERT BACLUONG VALUES ('BL004', N'Bậc lương IV', 7.28, null, 'NL004')
INSERT BACLUONG VALUES ('BL005', N'Bậc lương V', 7.56, null, 'NL005')

-- TẠO BẢNG NHÂN VIÊN
CREATE TABLE NHANVIEN
(
    MANV VARCHAR(10) PRIMARY KEY,
    HOTENNV NVARCHAR(50),
    GIOITINH BIT,
    NGAYSINH DATE,
    NOISINH NVARCHAR(50),
    QUEQUAN NVARCHAR(50),
    TRINHDOVANHOA CHAR(10), -- TRÌNH ĐỘ VĂN HOÁ
    DANTOC NVARCHAR(20),
    TONGIAO NVARCHAR(20),
    DOANVIEN BIT,
    DANGVIEN BIT,
    CONGDOANVIEN BIT, -- CÔNG ĐOÀN VIÊN
    MAPB VARCHAR(10),
    MACV VARCHAR(10),
    MANL VARCHAR(10),
    MABL VARCHAR(10),

    FOREIGN KEY(MAPB) REFERENCES PHONGBAN(MAPB),
    FOREIGN KEY(MACV) REFERENCES CHUCVU(MACV),
    FOREIGN KEY(MANL) REFERENCES NGACHLUONG(MANL),
    FOREIGN KEY(MABL) REFERENCES BACLUONG(MABL),
)
INSERT NHANVIEN VALUES ('NV00001', N'Lê Thị Bình', 0, '19920301', N'Bình Dương', N'Bình Dương', '12/12', N'Kinh', N'Đạo Phật', 1, 1, 1, 'PB001', 'CV001', 'NL001', 'BL001')
INSERT NHANVIEN VALUES ('NV00002', N'Trần Khánh Vân', 0, '19970705', N'Bình Thuận', N'Bình Thuận', '12/12', N'Kinh', N'Đạo Phật', 1, 0, 1, 'PB002', 'CV002', 'NL002', 'BL002')
INSERT NHANVIEN VALUES ('NV00003', N'Lê Tấn Đạt', 1, '20001030', N'Bình Định', N'Bình Định', '12/12', N'Kinh', N'Đạo Phật', 1, 0, 0, 'PB003', 'CV003', 'NL003', 'BL003')
INSERT NHANVIEN VALUES ('NV00004', N'Nguyễn Duy Khang', 1, '19990328', N'Biên Hòa', N'Biên Hòa', '12/12', N'Kinh', N'Đạo Phật', 1, 1, 0, 'PB002', 'CV004', 'NL004', 'BL004')
INSERT NHANVIEN VALUES ('NV00005', N'Nguyễn Phương Nhi', 0, '20010710', N'Phú Yên', N'Phú Yên', '12/12', N'Kinh', N'Đạo Phật', 1, 1, 1, 'PB001', 'CV005', 'NL005', 'BL005')
-- giới tính 0 là nữ, 1 là nam, đoàn viên 1 là có, 0 là không

-- TẠO BẢNG NGƯỜI THÂN
CREATE TABLE NGUOITHAN
(
    MANT VARCHAR(10) PRIMARY KEY,
	LOAINT NVARCHAR(30),
    HOTEN NVARCHAR(50),
    NGAYSINH DATE,
    NGHENGHIEP NVARCHAR(50),
    MANV VARCHAR(10),

    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
)
INSERT NGUOITHAN VALUES ('NT001', N'Cha', N'Lê Văn Tám', '19630427', N'Bán tạp hoá', 'NV00001')
INSERT NGUOITHAN VALUES ('NT002', N'Mẹ', N'Nguyễn Thị Chín', '19690428', N'Kinh doanh', 'NV00001') 
INSERT NGUOITHAN VALUES ('NT003', N'Cha', N'Trần Hữu Nghĩa', '19670927', N'Kinh doanh', 'NV00002')
INSERT NGUOITHAN VALUES ('NT004', N'Mẹ', N'Nguyễn Thị Bé', '19731027', N'Bán tạp hoá', 'NV00002') 
INSERT NGUOITHAN VALUES ('NT005', N'Cha', N'Lê Văn Khánh', '19800430', N'Ngư nghiệp', 'NV00003') 
INSERT NGUOITHAN VALUES ('NT006', N'Mẹ', N'Trần Tuyết Nhung', '19810506', N'Nông nghiệp', 'NV00004') 
INSERT NGUOITHAN VALUES ('NT007', N'Mẹ', N'Nguyễn Thị Chóng', '19770405', N'Công nhân', 'NV00004') 
INSERT NGUOITHAN VALUES ('NT008', N'Cha', N'Lê Văn Đông', '19650927', N'Kinh doanh', 'NV00005') 
-- ko nhất thiết là nhân viên cũng có người thân, 1 nhân viên có thể có nhiều người thân

-- TẠO BẢNG CHUYÊN MÔN
CREATE TABLE CHUYENMON
(
    MACM VARCHAR(10) PRIMARY KEY,
    TENCM NVARCHAR(50),
    TRINHDO CHAR(5),
)
INSERT CHUYENMON VALUES ('CM001', N'Quản lí phòng ban', 'A') -- trình độ có thể là chữ cái hoặc điểm, số vẫn thêm ' ' vào
INSERT CHUYENMON VALUES ('CM002', N'Tính toán doanh thu', 'A')
INSERT CHUYENMON VALUES ('CM003', N'Kiểm tra - đối soát doanh thu', 'A')
INSERT CHUYENMON VALUES ('CM004', N'Quản lí nhân sự', 'A')
INSERT CHUYENMON VALUES ('CM005', N'Quảng cáo sản phẩm', 'A')

-- TẠO BẢNG NHÂN VIÊN - CHUYÊN MÔN
CREATE TABLE NHANVIEN_CHUYENMON
(
    MANV VARCHAR(10) NOT NULL,
    MACM VARCHAR(10) NOT NULL,

    PRIMARY KEY(MANV, MACM),
    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
    FOREIGN KEY(MACM) REFERENCES CHUYENMON(MACM),
)
INSERT NHANVIEN_CHUYENMON VALUES ('NV00001', 'CM001')
INSERT NHANVIEN_CHUYENMON VALUES ('NV00002', 'CM002')
INSERT NHANVIEN_CHUYENMON VALUES ('NV00003', 'CM003')
INSERT NHANVIEN_CHUYENMON VALUES ('NV00004', 'CM004')
INSERT NHANVIEN_CHUYENMON VALUES ('NV00005', 'CM005')

-- TẠO BẢNG NGOẠI NGỮ
CREATE TABLE NGOAINGU
(
    MANN VARCHAR(10) PRIMARY KEY,
    TENNN NVARCHAR(50),
    TRINHDO CHAR(5),
)
INSERT NGOAINGU VALUES ('NN001', N'Toeic', 450)
INSERT NGOAINGU VALUES ('NN002', N'Ielts', 5.5)
INSERT NGOAINGU VALUES ('NN003', N'Toeic', 550)
INSERT NGOAINGU VALUES ('NN004', N'Ielts', 6.0)
INSERT NGOAINGU VALUES ('NN005', N'Toeic', 600)

-- TẠO BẢNG NHÂN VIÊN - NGOẠI NGỮ
CREATE TABLE NHANVIEN_NGOAINGU
(
    MANV VARCHAR(10) NOT NULL,
    MANN VARCHAR(10) NOT NULL,

    PRIMARY KEY(MANV, MANN),
    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
    FOREIGN KEY(MANN) REFERENCES NGOAINGU(MANN),
)
INSERT NHANVIEN_NGOAINGU VALUES ('NV00001', 'NN001')
INSERT NHANVIEN_NGOAINGU VALUES ('NV00002', 'NN002')
INSERT NHANVIEN_NGOAINGU VALUES ('NV00003', 'NN003')
INSERT NHANVIEN_NGOAINGU VALUES ('NV00004', 'NN004')
INSERT NHANVIEN_NGOAINGU VALUES ('NV00005', 'NN005')

-- TẠO BẢNG PHÒNG TỔ CHỨC
CREATE TABLE PHONGTOCHUC
(
    SOQUYETDINH VARCHAR(10) PRIMARY KEY,
    TENNGUOIKY NVARCHAR(50), -- TÊN NGƯỜI KÝ
    CHUCVUNGUOIKY VARCHAR(10), -- CHỨC VỤ NGƯỜI KÝ
    PHONGBANHIENTAI VARCHAR(10), -- PHÒNG BAN HIỆN TẠI
    PHONGBANTHUYENCHUYEN VARCHAR(10), -- PHÒNG BAN THUYÊN CHUYỂN

    FOREIGN KEY(CHUCVUNGUOIKY) REFERENCES CHUCVU(MACV),
    FOREIGN KEY(PHONGBANHIENTAI) REFERENCES PHONGBAN(MAPB),
    FOREIGN KEY(PHONGBANTHUYENCHUYEN) REFERENCES PHONGBAN(MAPB),  
)
INSERT PHONGTOCHUC VALUES ('1311/QD-PB', N'Lê Thị Bình', 'CV001', 'PB001', 'PB002')
INSERT PHONGTOCHUC VALUES ('0611/QD-PB', N'Lê Thị Bình', 'CV001', 'PB002', 'PB003')
INSERT PHONGTOCHUC VALUES ('1610/QD-PB', N'Lê Thị Bình', 'CV001', 'PB003', 'PB001')
INSERT PHONGTOCHUC VALUES ('1003/QD-PB', N'Lê Thị Bình', 'CV001', 'PB002', 'PB001')
INSERT PHONGTOCHUC VALUES ('0912/QD-PB', N'Lê Thị Bình', 'CV001', 'PB001', 'PB003')
-- TẠO BẢNG NHÂN VIÊN - PHÒNG TỔ CHỨC
CREATE TABLE NHANVIEN_PHONGTOCHUC
(
    MANV VARCHAR(10),
    SOQUYETDINH VARCHAR(10),

    PRIMARY KEY(MANV, SOQUYETDINH),
    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
    FOREIGN KEY(SOQUYETDINH) REFERENCES PHONGTOCHUC(SOQUYETDINH),
)
INSERT NHANVIEN_PHONGTOCHUC VALUES ('NV00001', '1311/QD-PB')
INSERT NHANVIEN_PHONGTOCHUC VALUES ('NV00002', '0611/QD-PB')
INSERT NHANVIEN_PHONGTOCHUC VALUES ('NV00003', '1610/QD-PB')
INSERT NHANVIEN_PHONGTOCHUC VALUES ('NV00004', '1003/QD-PB')
INSERT NHANVIEN_PHONGTOCHUC VALUES ('NV00005', '0912/QD-PB')

-- TẠO BẢNG PHÒNG BAN - PHÒNG TỔ CHỨC
CREATE TABLE PHONGBAN_PHONGTOCHUC
(
    MAPB VARCHAR(10),
    SOQUYETDINH VARCHAR(10),

    PRIMARY KEY(MAPB, SOQUYETDINH),
    FOREIGN KEY(MAPB) REFERENCES PHONGBAN(MAPB),
    FOREIGN KEY(SOQUYETDINH) REFERENCES PHONGTOCHUC(SOQUYETDINH),
)
INSERT PHONGBAN_PHONGTOCHUC VALUES ('PB001', '1311/QD-PB')
INSERT PHONGBAN_PHONGTOCHUC VALUES ('PB002', '0611/QD-PB')
INSERT PHONGBAN_PHONGTOCHUC VALUES ('PB003', '1610/QD-PB')
INSERT PHONGBAN_PHONGTOCHUC VALUES ('PB002', '1003/QD-PB')
INSERT PHONGBAN_PHONGTOCHUC VALUES ('PB001', '0912/QD-PB')


-- TẠO BẢNG HỘ GIA ĐÌNH
CREATE TABLE HOGIADINH
(
	MAHGD VARCHAR(10) PRIMARY KEY,
	MANV1 VARCHAR(10),
	MANV2 VARCHAR(10),

	FOREIGN KEY(MANV1) REFERENCES NHANVIEN(MANV),
	FOREIGN KEY(MANV2) REFERENCES NHANVIEN(MANV)
)
INSERT HOGIADINH VALUES ('P001', 'NV00001', NULL)
INSERT HOGIADINH VALUES ('P002', 'NV00002', NULL)
INSERT HOGIADINH VALUES ('P003', 'NV00003', NULL)
INSERT HOGIADINH VALUES ('P004', 'NV00004', NULL)
INSERT HOGIADINH VALUES ('P005', 'NV00005', NULL)

-- TẠO BẢNG ĐIỆN
CREATE TABLE DIEN
(
    MAD VARCHAR(10) PRIMARY KEY,
	MAHGD VARCHAR(10),
    THANG DATE,
    HESOTHANGTRUOC INT,
    HESOHIENTAI INT,
    DONVI char(5),

	FOREIGN KEY(MAHGD) REFERENCES HOGIADINH(MAHGD)
)
INSERT DIEN VALUES ('D0001', 'P001', '20231101', 0, 102, 'kW')
INSERT DIEN VALUES ('D0002', 'P002', '20231101', 0, 103, 'kW')
INSERT DIEN VALUES ('D0003', 'P003', '20231101', 0, 104, 'kW')
INSERT DIEN VALUES ('D0004', 'P004', '20231101', 0, 105, 'kW')
INSERT DIEN VALUES ('D0005', 'P005', '20231101', 0, 106, 'kW')

-- TẠO BẢNG NƯỚC
CREATE TABLE NUOC
(
    MAN VARCHAR(10) PRIMARY KEY,
	MAHGD VARCHAR(10),
    THANG DATE,
    HESOTHANGTRUOC INT,
    HESOHIENTAI INT,
    DONVI char(5),

	FOREIGN KEY(MAHGD) REFERENCES HOGIADINH(MAHGD)
)
INSERT NUOC VALUES ('N0001', 'P001', '20231101', 0, 12, 'm3')
INSERT NUOC VALUES ('N0002', 'P002', '20231101', 0, 13, 'm3')
INSERT NUOC VALUES ('N0003', 'P003', '20231101', 0, 14, 'm3')
INSERT NUOC VALUES ('N0004', 'P004', '20231101', 0, 15, 'm3')
INSERT NUOC VALUES ('N0005', 'P005', '20231101', 0, 16, 'm3')

-- TẠO BẢNG TIENNHA
CREATE TABLE TIENNHA
(
    MANTT VARCHAR(10) PRIMARY KEY,
	MAHGD VARCHAR(10),
    THANG DATE,
    TIENNHA INT,
    MAD VARCHAR(10),
    MAN VARCHAR(10),
    TIENPHIVESINHANNINHTRATTU INT, -- TIỀN PHÍ VỆ SINH AN NINH TRẬT TỰ

	FOREIGN KEY(MAHGD) REFERENCES HOGIADINH(MAHGD),
    FOREIGN KEY(MAD) REFERENCES DIEN(MAD),
    FOREIGN KEY(MAN) REFERENCES NUOC(MAN),
)
INSERT TIENNHA VALUES ('TN0001', 'P001', '20231101', 2500000, 'D0001', 'N0001', 50000)
INSERT TIENNHA VALUES ('TN0002', 'P002', '20231101', 2800000, 'D0001', 'N0002', 65000)
INSERT TIENNHA VALUES ('TN0003', 'P003', '20231101', 3000000, 'D0001', 'N0003', 50000)
INSERT TIENNHA VALUES ('TN0004', 'P004', '20231101', 2600000, 'D0001', 'N0004', 55000)
INSERT TIENNHA VALUES ('TN0005', 'P005', '20231101', 2900000, 'D0001', 'N0005', 60000)

-- TẠO BẢNG BỘ PHẬN CHẤM CÔNG
CREATE TABLE BOPHANCHAMCONG
(
    MACC VARCHAR(10) PRIMARY KEY,
    THANG DATE,
    SONGAYTRONGTHANG TINYINT, -- SỐ NGÀY TRONG THÁNG PHẢI ĐI LÀM
    SONGAYNGHIBHXH TINYINT, -- SỐ NGÀY NGHỈ BHXH
    SONGAYNGHIKHONGLYDO TINYINT, -- SỐ NGÀY NGHỈ KHÔNG LY DO
    MANV VARCHAR(10),

    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
)
INSERT BOPHANCHAMCONG VALUES ('CC0001', '20231031', 27, 1, 3, 'NV00001')
INSERT BOPHANCHAMCONG VALUES ('CC0002', '20231031', 27, 1, 0, 'NV00002')
INSERT BOPHANCHAMCONG VALUES ('CC0003', '20231031', 27, 0, 1, 'NV00003')
INSERT BOPHANCHAMCONG VALUES ('CC0004', '20231031', 27, 2, 0, 'NV00004')
INSERT BOPHANCHAMCONG VALUES ('CC0005', '20231031', 27, 1, 2, 'NV00005')

-- TẠO BẢNG LƯƠNG
CREATE TABLE LUONG
(
    MAL VARCHAR(10) PRIMARY KEY,
    THOIDIEM DATE,
    LUONGCOBAN INT,
    MANL VARCHAR(10),
    MABL VARCHAR(10),
    MACV VARCHAR(10),
    MACC VARCHAR(10),
    MATN VARCHAR(10), -- TIỀN NHÀ
    MANV VARCHAR(10),

    FOREIGN KEY(MANL) REFERENCES NGACHLUONG(MANL),
    FOREIGN KEY(MABL) REFERENCES BACLUONG(MABL),
    FOREIGN KEY(MACV) REFERENCES CHUCVU(MACV),
    FOREIGN KEY(MACC) REFERENCES BOPHANCHAMCONG(MACC),
    FOREIGN KEY(MATN) REFERENCES TIENNHA(MANTT),
    FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
)
INSERT LUONG VALUES ('L0001', '20231101', 6000000, 'NL001', 'BL001', 'CV001', 'CC0001', 'TN0001', 'NV00001')
INSERT LUONG VALUES ('L0002', '20231101', 5800000, 'NL002', 'BL002', 'CV002', 'CC0002', 'TN0002', 'NV00002')
INSERT LUONG VALUES ('L0003', '20231101', 7000000, 'NL003', 'BL003', 'CV003', 'CC0003', 'TN0003', 'NV00003')
INSERT LUONG VALUES ('L0004', '20231101', 6400000, 'NL004', 'BL004', 'CV004', 'CC0004', 'TN0004', 'NV00004')
INSERT LUONG VALUES ('L0005', '20231101', 6500000, 'NL005', 'BL005', 'CV005', 'CC0005', 'TN0005', 'NV00005')
GO
--STORE PROCEDURE
CREATE PROCEDURE usp_XoaChamCong
    @MaNhanVienCanXoa NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    -- Tắt ràng buộc khóa ngoại trên tất cả các bảng
    EXEC sp_MSforeachtable 'ALTER TABLE ? NOCHECK CONSTRAINT ALL';
    DELETE FROM BOPHANCHAMCONG WHERE MANV = @MaNhanVienCanXoa; 
    -- Bật lại ràng buộc khóa ngoại trên tất cả các bảng
    EXEC sp_MSforeachtable 'ALTER TABLE ? CHECK CONSTRAINT ALL';
END;
GO
--Function
CREATE FUNCTION dbo.CheckMACCAndMANVexists
(
    @MANV VARCHAR(10),
    @MACC VARCHAR(10)
)
RETURNS BIT
AS
BEGIN
    DECLARE @Result BIT;

    IF EXISTS (SELECT 1 FROM NHANVIEN WHERE MANV = @MANV)
    BEGIN
        IF EXISTS (SELECT 1 FROM BOPHANCHAMCONG WHERE MANV = @MANV AND MACC = @MACC)
        BEGIN
            SET @Result = 1; -- MANV và MACC tồn tại
        END
        ELSE
        BEGIN
            SET @Result = 0; -- MANV tồn tại, nhưng MACC không tồn tại
        END
    END
    ELSE
    BEGIN
        SET @Result = 0; -- MANV không tồn tại
    END

    RETURN @Result;
END;

GO






